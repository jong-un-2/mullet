# Mars Liquid - å®Œæ•´äº§å“è§£å†³æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v1.0.0  
> **æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ17æ—¥  
> **æ–‡æ¡£ç±»å‹**: äº§å“æŠ€æœ¯æ¶æ„æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

- [äº§å“æ¦‚è¿°](#äº§å“æ¦‚è¿°)
- [æ ¸å¿ƒä»·å€¼ä¸»å¼ ](#æ ¸å¿ƒä»·å€¼ä¸»å¼ )
- [æŠ€æœ¯æ¶æ„è®¾è®¡](#æŠ€æœ¯æ¶æ„è®¾è®¡)
- [åŸºç¡€è®¾æ–½æˆæœ¬](#åŸºç¡€è®¾æ–½æˆæœ¬)
- [æ•°æ®æµä¸çŠ¶æ€ç®¡ç†](#æ•°æ®æµä¸çŠ¶æ€ç®¡ç†)
- [å®‰å…¨ä¸åˆè§„](#å®‰å…¨ä¸åˆè§„)
- [æ‰©å±•æ€§ä¸æ€§èƒ½](#æ‰©å±•æ€§ä¸æ€§èƒ½)
- [è¿è¥ä¸ç›‘æ§](#è¿è¥ä¸ç›‘æ§)

---

## ğŸ¯ äº§å“æ¦‚è¿°

### äº§å“å®šä½

**Mars Liquid** æ˜¯ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„è·¨é“¾ DeFi æµåŠ¨æ€§èšåˆåè®®ï¼Œé€šè¿‡æ™ºèƒ½åˆçº¦è‡ªåŠ¨åŒ–å’Œè¾¹ç¼˜è®¡ç®—æŠ€æœ¯ï¼Œä¸ºç”¨æˆ·æä¾›ï¼š

1. **æ”¶ç›Šæœ€å¤§åŒ–** - å¤šåè®®èšåˆï¼ˆKamino + Jupiter<TODO>ï¼‰ï¼Œè‡ªåŠ¨å¤åˆ©ä¼˜åŒ–
2. **è·¨é“¾æµåŠ¨æ€§** - æ— ç¼èµ„äº§è½¬ç§»ï¼Œæ”¯æŒ Solanaã€Ethereum ç­‰ä¸»æµé“¾
3. **é›¶æ“ä½œç®¡ç†** - å…¨è‡ªåŠ¨åŒ–ç­–ç•¥æ‰§è¡Œï¼Œç”¨æˆ·åªéœ€å­˜å…¥èµ„äº§
4. **å®æ—¶é€æ˜** - é“¾ä¸Šæ•°æ®å®æ—¶ç´¢å¼•ï¼Œå®Œæ•´çš„å†å²è®°å½•å’Œåˆ†æ

### ç›®æ ‡ç”¨æˆ·

| ç”¨æˆ·ç±»å‹ | ç—›ç‚¹ | Mars Liquid è§£å†³æ–¹æ¡ˆ |
|---------|------|---------------------|
| **DeFi æ–°æ‰‹** | ä¸çŸ¥é“å¦‚ä½•é€‰æ‹©åè®®å’Œç­–ç•¥ | ä¸€é”®å­˜å…¥ï¼Œè‡ªåŠ¨ä¼˜åŒ–æ”¶ç›Š |
| **æ´»è·ƒäº¤æ˜“è€…** | è·¨é“¾æ“ä½œå¤æ‚ï¼ŒGas è´¹é«˜ | ç»Ÿä¸€ç•Œé¢ï¼Œæ™ºèƒ½è·¯ç”±ï¼Œæˆæœ¬ä¼˜åŒ– |
| **å¤§é¢æŠ•èµ„è€…** | éœ€è¦åˆ†æ•£é£é™©ï¼Œè¿½æ±‚ç¨³å®šæ”¶ç›Š | å¤šåè®®åˆ†æ•£ï¼Œå®æ—¶å†å¹³è¡¡ |
| **æœºæ„ç”¨æˆ·** | éœ€è¦é€æ˜åº¦å’Œå¯å®¡è®¡æ€§ | å®Œæ•´çš„é“¾ä¸Šè®°å½•ï¼ŒGraphQL æŸ¥è¯¢ |

---

## ğŸ’ æ ¸å¿ƒä»·å€¼ä¸»å¼ 

### 1. è·¨åè®®æ”¶ç›Šèšåˆ - æŠ€æœ¯å®ç°

```
ç”¨æˆ·å­˜æ¬¾ (USDC/PYUSD)
       â†“
Mars Vault Smart Contract
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚            â”‚              â”‚
Kamino Earn   Jupiter     Future Protocol  Oracle
(æµåŠ¨æ€§æŒ–çŸ¿)   (å€Ÿè´·)      (ç­–ç•¥æ‰©å±•)      (ä»·æ ¼æ•°æ®)
       â†“              â†“            â†“              â†“
è‡ªåŠ¨å†å¹³è¡¡ç®—æ³• (é“¾ä¸‹è®¡ç®— + é“¾ä¸Šæ‰§è¡Œ)
       â†“
æ”¶ç›Šè‡ªåŠ¨å¤åˆ© â†’ ç”¨æˆ·ä»½é¢å¢é•¿
```

**æŠ€æœ¯æ ˆ**:
- **Solana Smart Contract**: Anchor Framework 0.32.1
- **è·¨ç¨‹åºè°ƒç”¨ (CPI)**: Kamino SDK v7.1.8, Jupiter Aggregator
- **é“¾ä¸‹è®¡ç®—**: Cloudflare Workers + Hono.js
- **çŠ¶æ€ç®¡ç†**: Vault State (é“¾ä¸Š) + Durable Objects (é“¾ä¸‹)

### 2. å…¨çƒè¾¹ç¼˜è®¡ç®— API - æ€§èƒ½ä¼˜åŒ–

```
ç”¨æˆ·è¯·æ±‚ (å…¨çƒä»»æ„ä½ç½®)
       â†“
Cloudflare Edge Network (300+ åŸå¸‚)
       â†“
æœ€è¿‘çš„ Worker èŠ‚ç‚¹ (< 50ms å»¶è¿Ÿ)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚            â”‚              â”‚
KV Cache      D1 Database   PostgreSQL     R2 Storage
(å®æ—¶æ•°æ®)     (å¿«é€ŸæŸ¥è¯¢)   (å†å²æ•°æ®)     (é™æ€èµ„æº)
       â†“
æ™ºèƒ½ç¼“å­˜ç­–ç•¥ (å¤šå±‚ç¼“å­˜ + è‡ªåŠ¨é¢„çƒ­)
       â†“
API å“åº” (< 100ms P95)
```

**æŠ€æœ¯æ ˆ**:
- **è¾¹ç¼˜è®¡ç®—**: Cloudflare Workers (å…¨çƒ 300+ æ•°æ®ä¸­å¿ƒ)
- **ç¼“å­˜å±‚**: KV Namespace (< 1ms è¯»å–) + R2 CDN
- **æ•°æ®åº“**: D1 (SQLite) + PostgreSQL (Neon Serverless)
- **è¿æ¥æ± **: Hyperdrive (è‡ªåŠ¨æ‰©å±•ï¼Œä½å»¶è¿Ÿ)

### 3. å®æ—¶æ•°æ®ç´¢å¼• - Substreams æ¶æ„

```
Solana åŒºå—é“¾ (å®æ—¶åŒºå—)
       â†“
Substreams Engine (Rust + gRPC)
       â†“
Protocol Buffers åºåˆ—åŒ–
       â†“
Durable Objects Container
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚            â”‚              â”‚
äº‹ä»¶è§£æ      æ•°æ®è½¬æ¢      æ‰¹é‡æ’å…¥      GraphQL
(Rust)        (TypeScript)  (PostgreSQL)   (æŸ¥è¯¢å±‚)
       â†“
The Graph Subgraph (å»ä¸­å¿ƒåŒ–ç´¢å¼•)
       â†“
å®æ—¶æ•°æ®æ¨é€ (WebSocket)
```

**æŠ€æœ¯æ ˆ**:
- **æ•°æ®å¤„ç†**: Substreams (Rust + Protocol Buffers)
- **æŒä¹…åŒ–å®¹å™¨**: Cloudflare Durable Objects
- **æ•°æ®å­˜å‚¨**: PostgreSQL (Neon) + The Graph Protocol
- **å®æ—¶æ¨é€**: WebSocket + Server-Sent Events (SSE)

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯å±‚ (Frontend Layer)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  React 19 + Material-UI v7 + TypeScript                        â”‚    â”‚
â”‚  â”‚  â€¢ XLiquid (Vault ç®¡ç†)  â€¢ Portfolio (æŠ•èµ„ç»„åˆ)                 â”‚    â”‚
â”‚  â”‚  â€¢ Swap (DEX äº¤æ˜“)       â€¢ Pool (æµåŠ¨æ€§æ± )                      â”‚    â”‚
â”‚  â”‚  é’±åŒ…é›†æˆ: Phantom, Solflare, Rainbow, Privy                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†• HTTPS / WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ç½‘å…³å±‚ (Cloudflare Workers)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Mars API     â”‚ DEX API      â”‚ Cache API    â”‚ MCP Proxy        â”‚    â”‚
â”‚  â”‚ /api/mars/*  â”‚ /api/dex/*   â”‚ /api/cache/* â”‚ /api/mcp/*       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                    Hono.js Router + Middleware                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æœåŠ¡å±‚ (Service Layer)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Mars Protocol Service                                       â”‚    â”‚
â”‚  â”‚  â€¢ Vault æ•°æ®èšåˆ    â€¢ ç”¨æˆ·æŒä»“è®¡ç®—    â€¢ APY è®¡ç®—            â”‚    â”‚
â”‚  â”‚  â€¢ è·¨é“¾æ¡¥æ¥ (LI.FI)  â€¢ æ”¶ç›Šåˆ†é…        â€¢ å†å²æ•°æ®é‡‡é›†        â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  DEX Trading Service                                         â”‚    â”‚
â”‚  â”‚  â€¢ ä»·æ ¼èšåˆ          â€¢ æ™ºèƒ½è·¯ç”±        â€¢ äº¤æ˜“æ‰§è¡Œ            â”‚    â”‚
â”‚  â”‚  â€¢ æµåŠ¨æ€§ç®¡ç†        â€¢ æ»‘ç‚¹ä¿æŠ¤        â€¢ äº¤æ˜“å†å²            â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  Substreams Indexer (Durable Object)                         â”‚    â”‚
â”‚  â”‚  â€¢ å®æ—¶äº‹ä»¶ç›‘å¬      â€¢ å¢é‡åŒæ­¥        â€¢ çŠ¶æ€æŒä¹…åŒ–          â”‚    â”‚
â”‚  â”‚  â€¢ æ•°æ®è½¬æ¢          â€¢ æ‰¹é‡å†™å…¥        â€¢ é”™è¯¯æ¢å¤            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å±‚ (Data Layer)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ KV Cache     â”‚ D1 Database  â”‚ PostgreSQL   â”‚ R2 Storage       â”‚    â”‚
â”‚  â”‚ (å®æ—¶ç¼“å­˜)    â”‚ (SQLite)     â”‚ (Neon)       â”‚ (å¯¹è±¡å­˜å‚¨)        â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ â€¢ Vault çŠ¶æ€ â”‚ â€¢ ç”¨æˆ·æ•°æ®   â”‚ â€¢ å†å²è®°å½•   â”‚ â€¢ IDL æ–‡ä»¶       â”‚    â”‚
â”‚  â”‚ â€¢ ä»·æ ¼æ•°æ®   â”‚ â€¢ äº¤æ˜“è®°å½•   â”‚ â€¢ äº‹ä»¶æ—¥å¿—   â”‚ â€¢ é™æ€èµ„æº       â”‚    â”‚
â”‚  â”‚ â€¢ APY æ•°æ®   â”‚ â€¢ å…ƒæ•°æ®     â”‚ â€¢ åˆ†ææ•°æ®   â”‚ â€¢ å¤‡ä»½æ–‡ä»¶       â”‚    â”‚
â”‚  â”‚ TTL: 60s     â”‚ Sync: å®æ—¶   â”‚ Sync: æ‰¹é‡   â”‚ CDN åŠ é€Ÿ         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒºå—é“¾å±‚ (Blockchain Layer)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Solana Mainnet                                              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚ Mars Program   â”‚ Kamino Program â”‚ Jupiter Aggregator â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ 83Veoxix...    â”‚ (CPI)          â”‚ (CPI)              â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  EVM é“¾ (BSC, Ethereum, Polygon, Avalanche)                 â”‚    â”‚
â”‚  â”‚  â€¢ DEX åˆçº¦      â€¢ ä»£å¸åˆçº¦       â€¢ æ¡¥æ¥åˆçº¦                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¤–éƒ¨æœåŠ¡å±‚ (External Services)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Helius RPC   â”‚ The Graph    â”‚ Privy Auth   â”‚ LI.FI Bridge     â”‚    â”‚
â”‚  â”‚ (Solana èŠ‚ç‚¹)â”‚ (GraphQL)    â”‚ (é’±åŒ…ç™»å½•)   â”‚ (è·¨é“¾æ¡¥æ¥)        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæŠ€æœ¯æ ˆæ¸…å•

#### **1. å‰ç«¯æŠ€æœ¯æ ˆ**

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **React** | 19.0 | UI æ¡†æ¶ | æœ€æ–°å¹¶å‘ç‰¹æ€§ã€è‡ªåŠ¨æ‰¹å¤„ç†ã€æ€§èƒ½ä¼˜åŒ– |
| **TypeScript** | 5.x | ç±»å‹ç³»ç»Ÿ | ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ã€å‡å°‘è¿è¡Œæ—¶é”™è¯¯ |
| **Material-UI** | v7 | ç»„ä»¶åº“ | ç°ä»£è®¾è®¡ç³»ç»Ÿã€å®Œæ•´çš„å¯è®¿é—®æ€§æ”¯æŒ |
| **Vite** | 6.x | æ„å»ºå·¥å…· | é—ªç”µèˆ¬çš„ HMRã€åŸç”Ÿ ESMã€æŒ‰éœ€ç¼–è¯‘ |
| **wagmi** | 2.12 | EVM é’±åŒ… | React Hooksã€ç±»å‹å®‰å…¨ã€è‡ªåŠ¨ç¼“å­˜ |
| **@solana/wallet-adapter** | latest | Solana é’±åŒ… | å¤šé’±åŒ…æ”¯æŒã€æ ‡å‡†åŒ–æ¥å£ |
| **@kamino-finance/klend-sdk** | 7.1.8 | Kamino é›†æˆ | å®˜æ–¹ SDKã€å®Œæ•´ç±»å‹å®šä¹‰ |
| **@lifi/sdk** | 3.12.14 | è·¨é“¾æ¡¥æ¥ | èšåˆå¤šä¸ªæ¡¥ã€æœ€ä¼˜è·¯ç”± |
| **TanStack Query** | v5 | æ•°æ®åŒæ­¥ | å¼ºå¤§çš„ç¼“å­˜ã€è‡ªåŠ¨é‡è¯•ã€ä¹è§‚æ›´æ–° |

#### **2. åç«¯æŠ€æœ¯æ ˆ**

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **Cloudflare Workers** | - | è¾¹ç¼˜è®¡ç®— | å…¨çƒ 300+ èŠ‚ç‚¹ã€0ms å†·å¯åŠ¨ã€æŒ‰éœ€ä»˜è´¹ |
| **Hono.js** | 4.x | Web æ¡†æ¶ | è¶…è½»é‡ (< 13KB)ã€ç±»å‹å®‰å…¨ã€é«˜æ€§èƒ½ |
| **Drizzle ORM** | latest | æ•°æ®åº“ ORM | ç±»å‹å®‰å…¨ã€é›¶è¿è¡Œæ—¶å¼€é”€ã€SQL-first |
| **D1** | - | SQLite æ•°æ®åº“ | è¾¹ç¼˜è®¡ç®—å‹å¥½ã€ä½å»¶è¿Ÿã€è‡ªåŠ¨å¤åˆ¶ |
| **PostgreSQL (Neon)** | 16 | ä¸»æ•°æ®åº“ | Serverlessã€è‡ªåŠ¨æ‰©å±•ã€åˆ†æ”¯åŠŸèƒ½ |
| **Hyperdrive** | - | è¿æ¥æ±  | æ™ºèƒ½ç¼“å­˜ã€é™ä½å»¶è¿Ÿã€æé«˜åå |
| **KV Namespace** | - | é”®å€¼å­˜å‚¨ | < 1ms è¯»å–ã€å…¨çƒåˆ†å¸ƒã€é«˜å¯ç”¨ |
| **R2 Storage** | - | å¯¹è±¡å­˜å‚¨ | S3 å…¼å®¹ã€é›¶å‡ºç«™è´¹ç”¨ã€CDN é›†æˆ |
| **Durable Objects** | - | æœ‰çŠ¶æ€æœåŠ¡ | å¼ºä¸€è‡´æ€§ã€å…¨å±€å”¯ä¸€ã€è‡ªåŠ¨è¿ç§» |

#### **3. åŒºå—é“¾æŠ€æœ¯æ ˆ**

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **Anchor Framework** | 0.32.1 | Solana åˆçº¦ | ç±»å‹å®‰å…¨ã€IDL ç”Ÿæˆã€æµ‹è¯•æ¡†æ¶ |
| **Rust** | 1.77+ | åˆçº¦è¯­è¨€ | é›¶æˆæœ¬æŠ½è±¡ã€å†…å­˜å®‰å…¨ã€é«˜æ€§èƒ½ |
| **Solana Web3.js** | 1.98 | Solana SDK | å®˜æ–¹åº“ã€å®Œæ•´åŠŸèƒ½ã€è‰¯å¥½æ–‡æ¡£ |
| **@coral-xyz/anchor** | 0.32.1 | TS å®¢æˆ·ç«¯ | è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯ã€ç±»å‹å®‰å…¨ |
| **Substreams** | latest | æ•°æ®ç´¢å¼• | é«˜æ€§èƒ½ã€å¯ç»„åˆã€å¹¶è¡Œå¤„ç† |
| **Protocol Buffers** | 3.x | åºåˆ—åŒ– | é«˜æ•ˆã€è·¨è¯­è¨€ã€å‘åå…¼å®¹ |
| **The Graph** | - | GraphQL ç´¢å¼• | å»ä¸­å¿ƒåŒ–ã€å¼ºå¤§æŸ¥è¯¢ã€è®¢é˜…æ”¯æŒ |

#### **4. æ•°æ®åŸºç¡€è®¾æ–½**

| æŠ€æœ¯ | ç”¨é€” | æŠ€æœ¯ç‰¹ç‚¹ |
|------|------|---------|
| **Substreams (Rust)** | å®æ—¶æ•°æ®å¤„ç† | â€¢ æµå¼å¤„ç† Solana åŒºå—<br>â€¢ Protocol Buffers åºåˆ—åŒ–<br>â€¢ å¢é‡è®¡ç®—ä¸çŠ¶æ€ç®¡ç† |
| **Durable Objects** | å®¹å™¨åŒ–è¿è¡Œæ—¶ | â€¢ è¿è¡Œ Substreams å®¢æˆ·ç«¯<br>â€¢ æŒä¹…åŒ–çŠ¶æ€å­˜å‚¨<br>â€¢ è‡ªåŠ¨æ•…éšœæ¢å¤ |
| **PostgreSQL (Neon)** | å†å²æ•°æ®å­˜å‚¨ | â€¢ Serverless æ¶æ„<br>â€¢ åˆ†æ”¯åŠŸèƒ½ (ç±»ä¼¼ Git)<br>â€¢ è‡ªåŠ¨æ‰©å±• (0.25 - 8 CU) |
| **D1 (SQLite)** | å®æ—¶æŸ¥è¯¢ | â€¢ è¾¹ç¼˜è®¡ç®—å‹å¥½<br>â€¢ è‡ªåŠ¨å…¨çƒå¤åˆ¶<br>â€¢ ä½å»¶è¿Ÿè¯»å– |
| **The Graph** | GraphQL æŸ¥è¯¢ | â€¢ å»ä¸­å¿ƒåŒ–ç´¢å¼•<br>â€¢ å®æ—¶è®¢é˜…<br>â€¢ å¤æ‚æŸ¥è¯¢æ”¯æŒ |

---

## ğŸ’° åŸºç¡€è®¾æ–½æˆæœ¬

### æˆæœ¬ç»“æ„åˆ†æ

| æœåŠ¡ | æ–¹æ¡ˆ | æœˆåº¦æˆæœ¬ | åŒ…å«å†…å®¹ | è¶…é¢è®¡è´¹ |
|------|------|---------|---------|---------|
| **Cloudflare** | Workers + DO + R2 + KV | **$5** | â€¢ 10M è¯·æ±‚/æœˆ<br>â€¢ 1GB Durable Objects<br>â€¢ 10GB R2 å­˜å‚¨<br>â€¢ 100K KV æ“ä½œ | â€¢ è¯·æ±‚: $0.50/M<br>â€¢ DO: $0.15/GB<br>â€¢ R2: $0.015/GB |
| **Neon PostgreSQL** | Serverless | **$5** | â€¢ 1 ä¸ªé¡¹ç›®<br>â€¢ è‡ªåŠ¨æ‰©å±• (0.25-8 CU)<br>â€¢ 3GB å­˜å‚¨<br>â€¢ åˆ†æ”¯åŠŸèƒ½ | â€¢ è®¡ç®—: $0.16/CU-hour<br>â€¢ å­˜å‚¨: $0.000164/GB-hour |
| **Helius RPC** | Small Projects | **$49** | â€¢ 50M ä¿¡ç”¨é¢åº¦/æœˆ<br>â€¢ å¢å¼º RPC ç«¯ç‚¹<br>â€¢ WebSocket æ”¯æŒ<br>â€¢ ä¼˜å…ˆæ”¯æŒ | è¶…é¢éœ€å‡çº§è®¡åˆ’ |
| **Privy** | Free Tier | **$0** (150 MAU)<br>**$299** (2500 MAU) | â€¢ é’±åŒ…ç™»å½•<br>â€¢ ç¤¾äº¤ç™»å½•<br>â€¢ ç”¨æˆ·ç®¡ç†<br>â€¢ åˆ†æä»ªè¡¨æ¿ | æŒ‰æœˆæ´»ç”¨æˆ·é˜¶æ¢¯å®šä»· |
| **Substreams** | Free | **$0** (5GB å‡ºç«™)<br>**$100** (Business) | â€¢ 5M åŒºå—å¤„ç†<br>â€¢ 5GB å‡ºç«™æµé‡<br>â€¢ ç¤¾åŒºæ”¯æŒ | Business: æ— é™å—å¤„ç† |
| **LI.FI Bridge** | Standard | **$0** | â€¢ 200 è¯·æ±‚/åˆ†é’Ÿ<br>â€¢ $1M æœˆäº¤æ˜“é‡<br>â€¢ æ ‡å‡†æ”¯æŒ | ä¼ä¸šè®¡åˆ’éœ€è”ç³» |
| **The Graph** | æ‰˜ç®¡æœåŠ¡ | **$0** (åˆæœŸ) | â€¢ å»ä¸­å¿ƒåŒ–ç´¢å¼•<br>â€¢ GraphQL æŸ¥è¯¢<br>â€¢ è‡ªåŠ¨åŒæ­¥ | æŒ‰æŸ¥è¯¢é‡ä»˜è´¹ (æœªæ¥) |

### æˆæœ¬ä¼˜åŒ–ç­–ç•¥

#### **1. è¾¹ç¼˜è®¡ç®—æˆæœ¬ä¼˜åŒ–**

```typescript
// å¤šå±‚ç¼“å­˜ç­–ç•¥ - å‡å°‘æ•°æ®åº“æŸ¥è¯¢
const cacheStrategy = {
  // L1: KV Cache (< 1ms)
  kv: {
    ttl: 60, // 60 ç§’
    usage: 'hot data (ä»·æ ¼ã€TVLã€APY)'
  },
  
  // L2: Durable Objects (å†…å­˜)
  durableObjects: {
    ttl: 300, // 5 åˆ†é’Ÿ
    usage: 'aggregated data (ç”¨æˆ·æŒä»“æ±‡æ€»)'
  },
  
  // L3: D1 Database (æœ¬åœ° SQLite)
  d1: {
    ttl: 3600, // 1 å°æ—¶
    usage: 'user data (ç”¨æˆ·ä¿¡æ¯ã€äº¤æ˜“è®°å½•)'
  },
  
  // L4: PostgreSQL (è¿œç¨‹)
  postgres: {
    ttl: Infinity, // æ°¸ä¹…å­˜å‚¨
    usage: 'historical data (å†å²æ•°æ®ã€åˆ†æ)'
  }
};

// æ™ºèƒ½ç¼“å­˜é¢„çƒ­ - å‡å°‘å†·å¯åŠ¨
async function warmCache() {
  // å®šæ—¶ä»»åŠ¡æ¯ 5 åˆ†é’Ÿæ‰§è¡Œ
  // é¢„åŠ è½½çƒ­é—¨ Vault æ•°æ®
  // é¢„è®¡ç®—å¸¸ç”¨èšåˆæ•°æ®
  // æå‰åŠ è½½ä»·æ ¼æ•°æ®
}
```

#### **2. RPC è¯·æ±‚ä¼˜åŒ–**

```typescript
// æ‰¹é‡ RPC è°ƒç”¨ - å‡å°‘ Helius ä¿¡ç”¨æ¶ˆè€—
const batchRPC = {
  // ä½¿ç”¨ getMultipleAccounts ä»£æ›¿å¤šæ¬¡ getAccountInfo
  multipleAccounts: true,
  
  // WebSocket è®¢é˜…ä»£æ›¿è½®è¯¢
  websocket: {
    priceUpdates: true,
    accountChanges: true
  },
  
  // æœ¬åœ°ç¼“å­˜ Program IDL å’Œé™æ€æ•°æ®
  localCache: {
    idl: true,
    programId: true,
    constantAccounts: true
  }
};
```

#### **3. æ•°æ®åº“æˆæœ¬æ§åˆ¶**

```sql
-- Neon Serverless è‡ªåŠ¨æ‰©å±•ç­–ç•¥
-- é…ç½®æœ€å°/æœ€å¤§ CU é™åˆ¶
CREATE DATABASE mars_protocol WITH
  COMPUTE_SIZE_MIN = 0.25  -- ç©ºé—²æ—¶æœ€å°
  COMPUTE_SIZE_MAX = 2;    -- å³°å€¼æ—¶æœ€å¤§ (æ§åˆ¶æˆæœ¬)

-- ä½¿ç”¨åˆ†æ”¯åŠŸèƒ½è¿›è¡Œæµ‹è¯• (ä¸å ç”¨ç”Ÿäº§èµ„æº)
CREATE BRANCH staging FROM main;

-- å®šæœŸå½’æ¡£å†·æ•°æ®åˆ° R2 (é™ä½å­˜å‚¨æˆæœ¬)
INSERT INTO r2_archive 
SELECT * FROM vault_events 
WHERE timestamp < NOW() - INTERVAL '90 days';
```

#### **4. é¢„ä¼°æœˆåº¦æˆæœ¬**

| ç”¨æˆ·è§„æ¨¡ | è¯·æ±‚é‡ | æ€»æˆæœ¬ | æˆæœ¬æ˜ç»† |
|---------|--------|--------|---------|
| **åˆæœŸ** (< 500 ç”¨æˆ·) | < 10M/æœˆ | **$59** | Cloudflare $5 + Neon $5 + Helius $49 |
| **æˆé•¿æœŸ** (500-2500 ç”¨æˆ·) | 10-50M/æœˆ | **$373** | Cloudflare $15 + Neon $10 + Helius $49 + Privy $299 |
| **æ‰©å¼ æœŸ** (2500-10K ç”¨æˆ·) | 50-200M/æœˆ | **$573** | Cloudflare $35 + Neon $20 + Helius $99 + Privy $299 + Substreams $100 |

---

## ğŸ”„ æ•°æ®æµä¸çŠ¶æ€ç®¡ç†

### 1. ç”¨æˆ·å­˜æ¬¾æµç¨‹

```typescript
/**
 * ç”¨æˆ·å­˜æ¬¾å®Œæ•´æµç¨‹
 * ä»å‰ç«¯å‘èµ·åˆ°é“¾ä¸Šç¡®è®¤çš„å…¨è¿‡ç¨‹
 */

// ============= å‰ç«¯ (React) =============
async function handleDeposit(amount: number) {
  // Step 1: å‰ç«¯éªŒè¯
  if (amount < MIN_DEPOSIT) throw new Error('é‡‘é¢è¿‡å°');
  
  // Step 2: è°ƒç”¨ Mars API è·å– Vault çŠ¶æ€
  const vault = await fetch('/api/mars/vaults/PYUSD').then(r => r.json());
  
  // Step 3: æ„å»ºäº¤æ˜“
  const tx = await marsProgram.methods
    .deposit(new BN(amount * 1e6))
    .accounts({
      user: wallet.publicKey,
      vaultState: vault.address,
      userState: getUserStateAddress(wallet.publicKey),
      baseTokenMint: PYUSD_MINT,
      // ... å…¶ä»–è´¦æˆ·
    })
    .transaction();
  
  // Step 4: ç­¾åå¹¶å‘é€
  const signature = await wallet.sendTransaction(tx, connection);
  
  // Step 5: ç­‰å¾…ç¡®è®¤
  await connection.confirmTransaction(signature, 'confirmed');
  
  // Step 6: ä¹è§‚æ›´æ–° UI
  updateUIOptimistically(amount);
  
  // Step 7: åå°åŒæ­¥æœ€æ–°çŠ¶æ€
  invalidateQueries(['userPosition', wallet.publicKey]);
}

// ============= æ™ºèƒ½åˆçº¦ (Rust) =============
#[derive(Accounts)]
pub struct Deposit<'info> {
    #[account(mut)]
    pub user: Signer<'info>,
    
    #[account(
        mut,
        seeds = [b"mars-vault", base_token_mint.key().as_ref()],
        bump
    )]
    pub vault_state: Account<'info, VaultState>,
    
    #[account(
        init_if_needed,
        payer = user,
        space = 8 + UserState::LEN,
        seeds = [b"user-state", user.key().as_ref(), vault_state.key().as_ref()],
        bump
    )]
    pub user_state: Account<'info, UserState>,
    
    // ... å…¶ä»–è´¦æˆ·
}

pub fn deposit(ctx: Context<Deposit>, amount: u64) -> Result<()> {
    let vault = &mut ctx.accounts.vault_state;
    let user_state = &mut ctx.accounts.user_state;
    
    // 1. è½¬è´¦ç”¨æˆ·ä»£å¸åˆ° Vault
    token::transfer(
        CpiContext::new(
            ctx.accounts.token_program.to_account_info(),
            Transfer {
                from: ctx.accounts.user_token_account.to_account_info(),
                to: ctx.accounts.vault_token_account.to_account_info(),
                authority: ctx.accounts.user.to_account_info(),
            },
        ),
        amount,
    )?;
    
    // 2. è®¡ç®—ç”¨æˆ·ä»½é¢
    let shares = if vault.total_shares == 0 {
        amount // é¦–æ¬¡å­˜æ¬¾ï¼Œ1:1
    } else {
        amount * vault.total_shares / vault.total_assets
    };
    
    // 3. æ›´æ–°çŠ¶æ€
    vault.total_assets += amount;
    vault.total_shares += shares;
    user_state.shares += shares;
    user_state.deposited_amount += amount;
    
    // 4. è§¦å‘äº‹ä»¶
    emit!(VaultDepositEvent {
        user: ctx.accounts.user.key(),
        vault: vault.key(),
        amount,
        shares,
        timestamp: Clock::get()?.unix_timestamp,
    });
    
    // 5. è‡ªåŠ¨è´¨æŠ¼åˆ° Kamino (å¦‚æœå¯ç”¨)
    if vault.auto_stake {
        kamino_farm::cpi::stake(
            CpiContext::new_with_signer(
                ctx.accounts.kamino_program.to_account_info(),
                KaminoStake { /* ... */ },
                &[&[b"mars-vault", vault.base_token_mint.as_ref(), &[vault.bump]]],
            ),
            amount,
        )?;
    }
    
    Ok(())
}

// ============= Substreams (Rust) =============
#[substreams::handlers::map]
pub fn map_vault_events(block: Block) -> Result<VaultEvents, Error> {
    let mut events = VaultEvents::default();
    
    for trx in block.transactions {
        for instruction in trx.instructions {
            // è§£æ Mars Program çš„å­˜æ¬¾äº‹ä»¶
            if instruction.program_id == MARS_PROGRAM_ID {
                if let Some(event) = parse_deposit_event(&instruction) {
                    events.deposits.push(DepositEvent {
                        user: event.user.to_string(),
                        vault: event.vault.to_string(),
                        amount: event.amount,
                        shares: event.shares,
                        timestamp: block.timestamp,
                        signature: trx.signature.to_string(),
                    });
                }
            }
        }
    }
    
    Ok(events)
}

// ============= Durable Object (TypeScript) =============
export class SubstreamsIndexer {
  async handleVaultEvent(event: DepositEvent) {
    // 1. ä¿å­˜åˆ°å†…å­˜çŠ¶æ€
    this.state.vault_deposits.push(event);
    
    // 2. æ‰¹é‡å†™å…¥ PostgreSQL (æ¯ 100 æ¡æˆ– 10 ç§’)
    if (this.state.vault_deposits.length >= 100 || this.timeSinceLastFlush > 10) {
      await this.flushToDatabase();
    }
    
    // 3. æ›´æ–° KV ç¼“å­˜
    await this.env.VAULT_CACHE.put(
      `vault:${event.vault}:deposits`,
      JSON.stringify(this.state.vault_deposits),
      { expirationTtl: 60 }
    );
    
    // 4. è§¦å‘ WebSocket æ¨é€
    this.broadcast({
      type: 'DEPOSIT',
      data: event
    });
  }
  
  async flushToDatabase() {
    const client = await this.env.POSTGRES.connect();
    await client.query(
      `INSERT INTO vault_deposits (user_address, vault_address, amount, shares, timestamp, signature)
       VALUES ${this.state.vault_deposits.map(e => `('${e.user}', '${e.vault}', ${e.amount}, ${e.shares}, ${e.timestamp}, '${e.signature}')`).join(', ')}`
    );
    this.state.vault_deposits = [];
  }
}

// ============= API (Hono.js) =============
app.get('/api/mars/user/:address/positions', async (c) => {
  const userAddress = c.req.param('address');
  
  // 1. å°è¯•ä» KV ç¼“å­˜è¯»å–
  const cached = await c.env.USER_POSITION_CACHE.get(`user:${userAddress}`);
  if (cached) {
    return c.json(JSON.parse(cached));
  }
  
  // 2. ä» D1 æŸ¥è¯¢åŸºç¡€æ•°æ®
  const { results } = await c.env.DB.prepare(
    `SELECT vault_address, shares, deposited_amount 
     FROM user_states 
     WHERE user_address = ?`
  ).bind(userAddress).all();
  
  // 3. ä»é“¾ä¸ŠæŸ¥è¯¢å®æ—¶ Vault çŠ¶æ€
  const vaults = await Promise.all(
    results.map(async (r) => {
      const vaultState = await connection.getAccountInfo(new PublicKey(r.vault_address));
      const vault = marsProgram.coder.accounts.decode('VaultState', vaultState.data);
      
      // è®¡ç®—å½“å‰ä»·å€¼
      const currentValue = (r.shares * vault.total_assets) / vault.total_shares;
      const profit = currentValue - r.deposited_amount;
      const apy = calculateAPY(vault);
      
      return {
        vault: r.vault_address,
        shares: r.shares,
        deposited: r.deposited_amount,
        currentValue,
        profit,
        profitPercent: (profit / r.deposited_amount) * 100,
        apy
      };
    })
  );
  
  // 4. èšåˆæ€»è§ˆ
  const portfolio = {
    user: userAddress,
    totalDeposited: vaults.reduce((sum, v) => sum + v.deposited, 0),
    totalValue: vaults.reduce((sum, v) => sum + v.currentValue, 0),
    totalProfit: vaults.reduce((sum, v) => sum + v.profit, 0),
    vaults
  };
  
  // 5. ç¼“å­˜ç»“æœ
  await c.env.USER_POSITION_CACHE.put(
    `user:${userAddress}`,
    JSON.stringify(portfolio),
    { expirationTtl: 60 }
  );
  
  return c.json(portfolio);
});
```

### 2. å®æ—¶æ•°æ®åŒæ­¥æµç¨‹

```
Solana åŒºå—é“¾
       â†“ (æ–°åŒºå—)
Substreams Engine
       â†“ (äº‹ä»¶æµ)
Durable Objects (æ¶ˆè´¹è€…)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚            â”‚              â”‚
å†…å­˜èšåˆ       æ‰¹é‡å†™å…¥      KV ç¼“å­˜æ›´æ–°    WebSocket æ¨é€
(å®æ—¶è®¡ç®—)     (PostgreSQL) (TTL 60s)     (å®¢æˆ·ç«¯)
       â†“              â†“            â†“              â†“
ç”¨æˆ·æŸ¥è¯¢       å†å²åˆ†æ     å®æ—¶ API       å‰ç«¯æ›´æ–°
(< 100ms)      (GraphQL)    (< 50ms)       (< 1s)
```

---

## ğŸ”’ å®‰å…¨ä¸åˆè§„

### 1. æ™ºèƒ½åˆçº¦å®‰å…¨

#### **è®¿é—®æ§åˆ¶**

```rust
// å¤šçº§æƒé™ç®¡ç†
#[account]
pub struct GlobalState {
    pub admin: Pubkey,              // è¶…çº§ç®¡ç†å‘˜
    pub pending_admin: Pubkey,      // å¾…æ¥å—çš„ç®¡ç†å‘˜
    pub freeze_authority: Pubkey,   // ç´§æ€¥å†»ç»“æƒé™
    pub thaw_authority: Pubkey,     // è§£å†»æƒé™
    pub is_frozen: bool,            // å…¨å±€å†»ç»“çŠ¶æ€
}

// æƒé™æ£€æŸ¥å®
#[macro_export]
macro_rules! require_admin {
    ($global_state:expr, $signer:expr) => {
        require_keys_eq!(
            $global_state.admin,
            $signer.key(),
            ErrorCode::Unauthorized
        );
    };
}

// ç´§æ€¥æš‚åœæœºåˆ¶
pub fn freeze_global_state(ctx: Context<FreezeGlobalState>) -> Result<()> {
    require_admin!(ctx.accounts.global_state, ctx.accounts.signer);
    ctx.accounts.global_state.is_frozen = true;
    emit!(GlobalStateFrozenEvent { timestamp: Clock::get()?.unix_timestamp });
    Ok(())
}

// æ‰€æœ‰å…³é”®æ“ä½œéƒ½æ£€æŸ¥å†»ç»“çŠ¶æ€
pub fn deposit(ctx: Context<Deposit>, amount: u64) -> Result<()> {
    require!(!ctx.accounts.global_state.is_frozen, ErrorCode::SystemFrozen);
    // ... å­˜æ¬¾é€»è¾‘
}
```

#### **è¾“å…¥éªŒè¯**

```rust
// é‡‘é¢èŒƒå›´æ£€æŸ¥
pub fn deposit(ctx: Context<Deposit>, amount: u64) -> Result<()> {
    require!(
        amount >= MIN_DEPOSIT_AMOUNT,
        ErrorCode::DepositTooSmall
    );
    require!(
        amount <= MAX_DEPOSIT_AMOUNT,
        ErrorCode::DepositTooLarge
    );
    
    // æ£€æŸ¥ç”¨æˆ·ä½™é¢
    let user_balance = ctx.accounts.user_token_account.amount;
    require!(
        user_balance >= amount,
        ErrorCode::InsufficientBalance
    );
    
    // é˜²æ­¢æº¢å‡º
    let new_total = ctx.accounts.vault_state.total_assets
        .checked_add(amount)
        .ok_or(ErrorCode::MathOverflow)?;
    
    // ... ç»§ç»­æ‰§è¡Œ
}
```

#### **é‡å…¥æ”»å‡»é˜²æŠ¤**

```rust
// ä½¿ç”¨ Anchor çš„åŸå­æ€§ä¿è¯
// æ‰€æœ‰è´¦æˆ·ä¿®æ”¹åœ¨ä¸€ä¸ªäº¤æ˜“ä¸­å®Œæˆ
#[derive(Accounts)]
pub struct Withdraw<'info> {
    #[account(mut)]
    pub user: Signer<'info>,
    
    #[account(
        mut,
        has_one = user,  // ç¡®ä¿æ˜¯ç”¨æˆ·è‡ªå·±çš„è´¦æˆ·
        seeds = [b"user-state", user.key().as_ref(), vault_state.key().as_ref()],
        bump
    )]
    pub user_state: Account<'info, UserState>,
    
    // ... å…¶ä»–è´¦æˆ·
}

pub fn withdraw(ctx: Context<Withdraw>, shares: u64) -> Result<()> {
    // 1. å…ˆå‡å°‘ä»½é¢ (é˜²æ­¢é‡å…¥)
    ctx.accounts.user_state.shares = ctx.accounts.user_state.shares
        .checked_sub(shares)
        .ok_or(ErrorCode::InsufficientShares)?;
    
    // 2. è®¡ç®—ææ¬¾é‡‘é¢
    let amount = (shares * ctx.accounts.vault_state.total_assets) 
        / ctx.accounts.vault_state.total_shares;
    
    // 3. è½¬è´¦ (å³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“çŠ¶æ€ï¼Œå› ä¸ºæ˜¯åŸå­æ“ä½œ)
    token::transfer(/* ... */, amount)?;
    
    // 4. æ›´æ–° Vault çŠ¶æ€
    ctx.accounts.vault_state.total_shares -= shares;
    ctx.accounts.vault_state.total_assets -= amount;
    
    Ok(())
}
```

### 2. API å®‰å…¨

#### **é€Ÿç‡é™åˆ¶**

```typescript
// Cloudflare Workers é€Ÿç‡é™åˆ¶
app.use('*', async (c, next) => {
  const ip = c.req.header('CF-Connecting-IP');
  const rateLimitKey = `rate_limit:${ip}`;
  
  // ä½¿ç”¨ KV è¿›è¡Œé€Ÿç‡é™åˆ¶
  const current = await c.env.RATE_LIMIT.get(rateLimitKey);
  const count = current ? parseInt(current) : 0;
  
  if (count > 100) { // 100 è¯·æ±‚/åˆ†é’Ÿ
    return c.json({ error: 'Rate limit exceeded' }, 429);
  }
  
  await c.env.RATE_LIMIT.put(
    rateLimitKey,
    String(count + 1),
    { expirationTtl: 60 }
  );
  
  await next();
});
```

#### **è®¤è¯ä¸æˆæƒ**

```typescript
// Privy JWT éªŒè¯
import { verifyToken } from '@privy-io/server-auth';

app.use('/api/user/*', async (c, next) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '');
  
  if (!token) {
    return c.json({ error: 'Unauthorized' }, 401);
  }
  
  try {
    const claims = await verifyToken(token, c.env.PRIVY_APP_SECRET);
    c.set('user', claims);
    await next();
  } catch (error) {
    return c.json({ error: 'Invalid token' }, 401);
  }
});
```

#### **æ•°æ®åŠ å¯†**

```typescript
// æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
async function encryptUserData(data: any, userId: string) {
  const encoder = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    encoder.encode(process.env.ENCRYPTION_KEY),
    { name: 'PBKDF2' },
    false,
    ['deriveBits', 'deriveKey']
  );
  
  const key = await crypto.subtle.deriveKey(
    {
      name: 'PBKDF2',
      salt: encoder.encode(userId),
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    true,
    ['encrypt', 'decrypt']
  );
  
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv },
    key,
    encoder.encode(JSON.stringify(data))
  );
  
  return {
    iv: Array.from(iv),
    data: Array.from(new Uint8Array(encrypted))
  };
}
```

### 3. åˆè§„æ€§

#### **æ•°æ®éšç§ (GDPR/CCPA)**

```typescript
// ç”¨æˆ·æ•°æ®å¯¼å‡º
app.get('/api/user/:address/export', async (c) => {
  const userAddress = c.req.param('address');
  
  // éªŒè¯ç”¨æˆ·èº«ä»½
  const authenticatedUser = c.get('user');
  if (authenticatedUser.walletAddress !== userAddress) {
    return c.json({ error: 'Forbidden' }, 403);
  }
  
  // å¯¼å‡ºæ‰€æœ‰ç”¨æˆ·æ•°æ®
  const userData = {
    profile: await getUserProfile(userAddress),
    positions: await getUserPositions(userAddress),
    transactions: await getUserTransactions(userAddress),
    settings: await getUserSettings(userAddress)
  };
  
  return c.json(userData);
});

// ç”¨æˆ·æ•°æ®åˆ é™¤ (Right to be Forgotten)
app.delete('/api/user/:address', async (c) => {
  const userAddress = c.req.param('address');
  
  // éªŒè¯ç”¨æˆ·èº«ä»½
  const authenticatedUser = c.get('user');
  if (authenticatedUser.walletAddress !== userAddress) {
    return c.json({ error: 'Forbidden' }, 403);
  }
  
  // è½¯åˆ é™¤ (ä¿ç•™é“¾ä¸Šæ•°æ®ï¼Œåˆ é™¤é“¾ä¸‹ PII)
  await c.env.DB.prepare(
    `UPDATE users SET 
     email = NULL, 
     phone = NULL, 
     deleted_at = ? 
     WHERE address = ?`
  ).bind(Date.now(), userAddress).run();
  
  return c.json({ success: true });
});
```

#### **å®¡è®¡æ—¥å¿—**

```typescript
// æ‰€æœ‰å…³é”®æ“ä½œè®°å½•å®¡è®¡æ—¥å¿—
async function logAuditEvent(event: {
  type: string;
  user: string;
  action: string;
  details: any;
}) {
  await postgres.query(
    `INSERT INTO audit_logs (type, user_address, action, details, timestamp)
     VALUES ($1, $2, $3, $4, $5)`,
    [event.type, event.user, event.action, JSON.stringify(event.details), Date.now()]
  );
}

// ä½¿ç”¨ç¤ºä¾‹
await logAuditEvent({
  type: 'ADMIN_ACTION',
  user: adminAddress,
  action: 'UPDATE_VAULT_PARAMS',
  details: { vaultId, oldParams, newParams }
});
```

---

## ğŸ“ˆ æ‰©å±•æ€§ä¸æ€§èƒ½

### 1. æ°´å¹³æ‰©å±•æ¶æ„

```
è´Ÿè½½å‡è¡¡ (Cloudflare Load Balancer)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚            â”‚              â”‚
Worker 1      Worker 2     Worker 3       Worker N
(æ¬§æ´²èŠ‚ç‚¹)     (ç¾å›½èŠ‚ç‚¹)   (äºšæ´²èŠ‚ç‚¹)     (åŠ¨æ€æ‰©å±•)
       â†“              â†“            â†“              â†“
å…±äº« KV Namespace (å…¨çƒåˆ†å¸ƒå¼ç¼“å­˜)
       â†“
PostgreSQL Read Replicas (åªè¯»å‰¯æœ¬)
       â†“
PostgreSQL Primary (ä¸»åº“ - å†™å…¥)
```

### 2. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**

```sql
-- ä¸ºé«˜é¢‘æŸ¥è¯¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_states_user ON user_states(user_address);
CREATE INDEX idx_vault_deposits_vault ON vault_deposits(vault_address);
CREATE INDEX idx_vault_deposits_timestamp ON vault_deposits(timestamp DESC);

-- ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—èšåˆæ•°æ®
CREATE MATERIALIZED VIEW vault_stats AS
SELECT 
  vault_address,
  COUNT(DISTINCT user_address) as user_count,
  SUM(amount) as total_deposited,
  AVG(amount) as avg_deposit,
  MAX(timestamp) as last_deposit
FROM vault_deposits
GROUP BY vault_address;

-- å®šæ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾ (æ¯ 5 åˆ†é’Ÿ)
REFRESH MATERIALIZED VIEW vault_stats;
```

#### **CDN åŠ é€Ÿ**

```typescript
// é™æ€èµ„æºä½¿ç”¨ R2 + CDN
app.get('/idl/:programId', async (c) => {
  const programId = c.req.param('programId');
  
  // è®¾ç½®å¼ºç¼“å­˜å¤´
  c.header('Cache-Control', 'public, max-age=31536000, immutable');
  c.header('CDN-Cache-Control', 'max-age=31536000');
  
  // ä» R2 è¯»å–
  const idl = await c.env.STATIC_ASSETS.get(`idl/${programId}.json`);
  return c.json(JSON.parse(idl));
});
```

#### **æ‰¹é‡å¤„ç†**

```typescript
// æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·æŒä»“
app.post('/api/mars/positions/batch', async (c) => {
  const { addresses } = await c.req.json();
  
  // å¹¶å‘æŸ¥è¯¢ (æœ€å¤š 10 ä¸ªå¹¶å‘)
  const positions = await Promise.all(
    addresses.map((addr: string) => 
      getUserPositions(addr).catch(() => null)
    )
  );
  
  return c.json(
    positions.filter(p => p !== null)
  );
});
```

### 3. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰ | ä¼˜åŒ–æªæ–½ |
|------|------|------|---------|
| **API å“åº”æ—¶é—´ (P50)** | < 50ms | ~45ms | âœ… KV ç¼“å­˜ + è¾¹ç¼˜è®¡ç®— |
| **API å“åº”æ—¶é—´ (P95)** | < 100ms | ~95ms | âœ… æŸ¥è¯¢ä¼˜åŒ– + æ•°æ®åº“ç´¢å¼• |
| **API å“åº”æ—¶é—´ (P99)** | < 200ms | ~180ms | ğŸ”„ å¢åŠ  Worker å¹¶å‘æ•° |
| **äº¤æ˜“ç¡®è®¤æ—¶é—´** | < 30s | ~25s | âœ… Helius RPC + ä¼˜å…ˆè´¹ |
| **æ•°æ®åŒæ­¥å»¶è¿Ÿ** | < 5s | ~3s | âœ… Substreams æµå¼å¤„ç† |
| **WebSocket å»¶è¿Ÿ** | < 1s | ~800ms | âœ… Durable Objects æ¨é€ |
| **é¡µé¢åŠ è½½æ—¶é—´ (FCP)** | < 1.5s | ~1.2s | âœ… Vite ä»£ç åˆ†å‰² + CDN |
| **é¡µé¢åŠ è½½æ—¶é—´ (LCP)** | < 2.5s | ~2.1s | âœ… å›¾ç‰‡ä¼˜åŒ– + é¢„åŠ è½½ |

---

## ğŸ” è¿è¥ä¸ç›‘æ§

### 1. ç›‘æ§æŒ‡æ ‡

#### **ç³»ç»Ÿå¥åº·æŒ‡æ ‡**

```typescript
// Cloudflare Workers åˆ†æ
export default {
  async scheduled(event: ScheduledEvent, env: Env) {
    // æ¯åˆ†é’Ÿæ”¶é›†ç³»ç»ŸæŒ‡æ ‡
    const metrics = {
      // Worker æŒ‡æ ‡
      workerRequests: await getWorkerRequestCount(),
      workerErrors: await getWorkerErrorCount(),
      workerLatency: await getWorkerLatencyP95(),
      
      // æ•°æ®åº“æŒ‡æ ‡
      dbConnections: await getDBConnectionCount(),
      dbQueryTime: await getDBQueryTimeP95(),
      
      // ç¼“å­˜æŒ‡æ ‡
      cacheHitRate: await getCacheHitRate(),
      cacheEvictions: await getCacheEvictionCount(),
      
      // ä¸šåŠ¡æŒ‡æ ‡
      activeUsers: await getActiveUserCount(),
      totalTVL: await getTotalTVL(),
      transactionCount: await getTransactionCount(),
    };
    
    // å‘é€åˆ°ç›‘æ§æœåŠ¡
    await sendMetrics(metrics);
    
    // å‘Šè­¦æ£€æŸ¥
    if (metrics.workerErrors > 100) {
      await sendAlert('High error rate detected');
    }
    
    if (metrics.dbQueryTime > 500) {
      await sendAlert('Database slow query detected');
    }
  }
};
```

#### **ä¸šåŠ¡æŒ‡æ ‡çœ‹æ¿**

```typescript
// å®æ—¶ä¸šåŠ¡æ•°æ®
app.get('/api/admin/dashboard', async (c) => {
  const [
    vaultStats,
    userStats,
    transactionStats,
    revenueStats
  ] = await Promise.all([
    // Vault ç»Ÿè®¡
    postgres.query(`
      SELECT 
        COUNT(*) as vault_count,
        SUM(total_assets) as total_tvl,
        AVG(apy) as avg_apy
      FROM vault_states
    `),
    
    // ç”¨æˆ·ç»Ÿè®¡
    postgres.query(`
      SELECT 
        COUNT(DISTINCT user_address) as total_users,
        COUNT(DISTINCT CASE WHEN last_active > NOW() - INTERVAL '24 hours' THEN user_address END) as dau,
        COUNT(DISTINCT CASE WHEN last_active > NOW() - INTERVAL '7 days' THEN user_address END) as wau,
        COUNT(DISTINCT CASE WHEN last_active > NOW() - INTERVAL '30 days' THEN user_address END) as mau
      FROM user_states
    `),
    
    // äº¤æ˜“ç»Ÿè®¡
    postgres.query(`
      SELECT 
        COUNT(*) as total_transactions,
        SUM(amount) as total_volume,
        AVG(amount) as avg_transaction_size
      FROM vault_deposits
      WHERE timestamp > NOW() - INTERVAL '24 hours'
    `),
    
    // æ”¶å…¥ç»Ÿè®¡
    postgres.query(`
      SELECT 
        SUM(platform_fee) as total_fees,
        SUM(performance_fee) as performance_fees,
        SUM(management_fee) as management_fees
      FROM fee_collection
      WHERE collected_at > NOW() - INTERVAL '30 days'
    `)
  ]);
  
  return c.json({
    vaults: vaultStats.rows[0],
    users: userStats.rows[0],
    transactions: transactionStats.rows[0],
    revenue: revenueStats.rows[0]
  });
});
```

### 2. æ—¥å¿—ç³»ç»Ÿ

```typescript
// ç»“æ„åŒ–æ—¥å¿—
interface LogEvent {
  level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR';
  message: string;
  context: Record<string, any>;
  timestamp: number;
  requestId: string;
}

function log(event: LogEvent) {
  // æœ¬åœ°æ‰“å°
  console.log(JSON.stringify(event));
  
  // å‘é€åˆ°æ—¥å¿—æœåŠ¡ (å¦‚ Axiom, Logtail)
  fetch('https://logs.service.com/api/log', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(event)
  });
}

// ä½¿ç”¨ç¤ºä¾‹
app.use('*', async (c, next) => {
  const requestId = crypto.randomUUID();
  c.set('requestId', requestId);
  
  const startTime = Date.now();
  
  try {
    await next();
    
    log({
      level: 'INFO',
      message: 'Request completed',
      context: {
        method: c.req.method,
        path: c.req.path,
        status: c.res.status,
        duration: Date.now() - startTime
      },
      timestamp: Date.now(),
      requestId
    });
  } catch (error) {
    log({
      level: 'ERROR',
      message: 'Request failed',
      context: {
        method: c.req.method,
        path: c.req.path,
        error: error.message,
        stack: error.stack
      },
      timestamp: Date.now(),
      requestId
    });
    throw error;
  }
});
```

### 3. å‘Šè­¦ç³»ç»Ÿ

```typescript
// å®šä¹‰å‘Šè­¦è§„åˆ™
const alertRules = [
  {
    name: 'High Error Rate',
    condition: (metrics) => metrics.errorRate > 0.05, // 5% é”™è¯¯ç‡
    severity: 'CRITICAL',
    channels: ['email', 'slack', 'pagerduty']
  },
  {
    name: 'Low Cache Hit Rate',
    condition: (metrics) => metrics.cacheHitRate < 0.80, // 80% å‘½ä¸­ç‡
    severity: 'WARNING',
    channels: ['slack']
  },
  {
    name: 'Database Connection Pool Exhausted',
    condition: (metrics) => metrics.dbConnections > 90, // 90% ä½¿ç”¨ç‡
    severity: 'CRITICAL',
    channels: ['email', 'pagerduty']
  },
  {
    name: 'TVL Drop',
    condition: (metrics) => metrics.tvlChange < -0.10, // ä¸‹é™ 10%
    severity: 'HIGH',
    channels: ['email', 'slack']
  }
];

// å‘Šè­¦å‘é€
async function sendAlert(alert: {
  rule: string;
  severity: string;
  message: string;
  metrics: any;
}) {
  // å‘é€åˆ° Slack
  await fetch(process.env.SLACK_WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      text: `ğŸš¨ ${alert.severity}: ${alert.rule}`,
      blocks: [
        {
          type: 'section',
          text: {
            type: 'mrkdwn',
            text: alert.message
          }
        },
        {
          type: 'section',
          text: {
            type: 'mrkdwn',
            text: `\`\`\`${JSON.stringify(alert.metrics, null, 2)}\`\`\``
          }
        }
      ]
    })
  });
  
  // å‘é€é‚®ä»¶ (å¦‚æœæ˜¯ CRITICAL)
  if (alert.severity === 'CRITICAL') {
    await sendEmail({
      to: 'ops@marsliquid.com',
      subject: `[CRITICAL] ${alert.rule}`,
      body: alert.message
    });
  }
}
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯é€‰å‹å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| **åŒºå—é“¾** | Solana | é«˜æ€§èƒ½ (65K TPS)ã€ä½è´¹ç”¨ (< $0.01)ã€ä¸°å¯Œ DeFi ç”Ÿæ€ |
| **æ™ºèƒ½åˆçº¦æ¡†æ¶** | Anchor | ç±»å‹å®‰å…¨ã€IDL è‡ªåŠ¨ç”Ÿæˆã€ä¸°å¯Œå·¥å…·é“¾ |
| **åç«¯æ¶æ„** | Cloudflare Workers | å…¨çƒåˆ†å¸ƒã€0ms å†·å¯åŠ¨ã€æŒ‰éœ€ä»˜è´¹ã€æ— è¿ç»´ |
| **æ•°æ®åº“** | D1 + PostgreSQL | è¾¹ç¼˜å‹å¥½ + å¼ºå¤§æŸ¥è¯¢ã€åŒå†™ä¿è¯å¯é æ€§ |
| **æ•°æ®ç´¢å¼•** | Substreams + The Graph | é«˜æ€§èƒ½æµå¤„ç† + å»ä¸­å¿ƒåŒ–æŸ¥è¯¢ |
| **å‰ç«¯æ¡†æ¶** | React 19 + MUI v7 | æœ€æ–°ç‰¹æ€§ã€å®Œå–„ç”Ÿæ€ã€ä¼ä¸šçº§ç»„ä»¶ |
| **è·¨é“¾æ¡¥** | LI.FI | èšåˆå¤šä¸ªæ¡¥ã€æœ€ä¼˜è·¯ç”±ã€å…è´¹é¢åº¦ |
| **è®¤è¯** | Privy | Web3 å‹å¥½ã€ç¤¾äº¤ç™»å½•ã€åˆç†å®šä»· |

### äº§å“ä¼˜åŠ¿

1. **æˆæœ¬æ•ˆç‡**: 
   - åˆæœŸæˆæœ¬ < $60/æœˆ
   - Serverless æ¶æ„æŒ‰éœ€ä»˜è´¹
   - å¤šå±‚ç¼“å­˜å‡å°‘ RPC è°ƒç”¨

2. **æ€§èƒ½è¡¨ç°**:
   - API å“åº” < 100ms (P95)
   - å…¨çƒ CDN åŠ é€Ÿ
   - å®æ—¶æ•°æ®åŒæ­¥ < 5s

3. **å¼€å‘æ•ˆç‡**:
   - ç«¯åˆ°ç«¯ TypeScript ç±»å‹å®‰å…¨
   - è‡ªåŠ¨ç”Ÿæˆ SDK å’Œæ–‡æ¡£
   - å®Œå–„çš„æµ‹è¯•å’Œ CI/CD

4. **å¯æ‰©å±•æ€§**:
   - æ°´å¹³æ‰©å±•æ¶æ„
   - æ— çŠ¶æ€ Worker èŠ‚ç‚¹
   - æ•°æ®åº“è‡ªåŠ¨æ‰©å±•

5. **å®‰å…¨æ€§**:
   - æ™ºèƒ½åˆçº¦å¤šå±‚æƒé™æ§åˆ¶
   - API é€Ÿç‡é™åˆ¶å’Œè®¤è¯
   - å®Œæ•´çš„å®¡è®¡æ—¥å¿—

### æœªæ¥è·¯çº¿å›¾

#### **Phase 1 (Q3 2025)**: MVP ä¸Šçº¿
- âœ… Mars Protocol æ ¸å¿ƒåŠŸèƒ½
- âœ… Solana æ™ºèƒ½åˆçº¦éƒ¨ç½²
- âœ… åŸºç¡€ API å’Œå‰ç«¯
- âœ… Kamino Earn é›†æˆ

#### **Phase 2 (Q4 2025)**: åŠŸèƒ½æ‰©å±•
- ğŸ”„ å¤šé“¾æ”¯æŒ (BSC, Ethereum)
- ğŸ”„ é«˜çº§äº¤æ˜“ç­–ç•¥
- ğŸ”„ ç¤¾åŒºæ²»ç† (DAO)
- ğŸ”„ ç§»åŠ¨ç«¯åº”ç”¨
- ğŸ“‹ è·¨é“¾æµåŠ¨æ€§ä¼˜åŒ–

#### **Phase 3 (Q1 2026)**: ç”Ÿæ€å»ºè®¾
- ğŸ“‹ AI é©±åŠ¨ç­–ç•¥
- ğŸ“‹ å…¨çƒå¸‚åœºæ‰©å¼ 
- ğŸ“‹ API å¼€æ”¾å¹³å°
- ğŸ“‹ ç¬¬ä¸‰æ–¹é›†æˆ
- ğŸ“‹ æœºæ„ç‰ˆäº§å“
- ğŸ“‹ è®¸å¯è¯å’Œåˆè§„


---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ17æ—¥  
**ç»´æŠ¤è€…**: Mars Liquid Team  
**è”ç³»æ–¹å¼**: tech@marsliquid.com
