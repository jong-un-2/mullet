specVersion: v0.1.0
package:
  name: mars_vaults_substreams_graph
  version: v1.0.0

protobuf:
  files:
    - vault_events.proto
    - substreams/entity/v1/entity.proto
  importPaths:
    - ./proto

binaries:
  default:
    type: wasm/rust-v1
    file: ./target/wasm32-unknown-unknown/release/mars_vaults_substreams.wasm

modules:
  # 1. Parse all blocks and extract Mars vault transactions
  - name: map_blocks
    kind: map
    initialBlock: 370500000
    inputs:
      - source: sf.solana.type.v1.Block
    output:
      type: proto:mars.vaults.v1.Events

  # 2. Filter and transform vault events
  - name: map_vault_events
    kind: map
    initialBlock: 370500000
    inputs:
      - map: map_blocks
    output:
      type: proto:mars.vaults.v1.Events
    
  # 3. Maintain vault state snapshots (aggregation)
  - name: store_vault_states
    kind: store
    initialBlock: 370500000
    updatePolicy: set
    valueType: proto:mars.vaults.v1.VaultSnapshot
    inputs:
      - map: map_vault_events
    
  # 4. Graph output module for The Graph Protocol
  - name: graph_out
    kind: map
    initialBlock: 370500000
    inputs:
      - map: map_vault_events
      - store: store_vault_states
        mode: deltas
    output:
      type: proto:substreams.entity.v1.EntityChanges

network: solana-mainnet

# The Graph Protocol Usage:
# 1. Pack substreams: substreams pack substreams-graph.yaml
# 2. Deploy to Graph: graph deploy --subgraph mars-vaults-v8.spkg
#
# Expected entities:
#   - VaultDeposit
#   - VaultWithdrawal
#   - VaultSwap
#   - VaultRebalance
#   - VaultState
#   - UserPosition