syntax = "proto3";

package mars.vaults.v1;

// Main events container
message Events {
  repeated VaultEvent events = 1;
}

// Wrapper for all vault events
message VaultEvent {
  string signature = 1;
  uint64 slot = 2;
  int64 timestamp = 3;
  string program_id = 4;
  oneof event {
    VaultDepositEvent vault_deposit = 5;
    VaultWithdrawEvent vault_withdraw = 6;
    VaultStateUpdatedEvent vault_state_updated = 7;
    ProtocolConfigUpdatedEvent protocol_config_updated = 8;
    FeeConfigUpdatedEvent fee_config_updated = 9;
    EmergencyEvent emergency = 10;
    KaminoDepositEvent kamino_deposit = 11;
    KaminoWithdrawEvent kamino_withdraw = 12;
    KaminoStakeEvent kamino_stake = 13;
    KaminoUnstakeEvent kamino_unstake = 14;
    FarmRewardsClaimedEvent farm_rewards_claimed = 15;
    PlatformFeeUpdatedEvent platform_fee_updated = 16;
    PlatformFeeWalletUpdatedEvent platform_fee_wallet_updated = 17;
  }
}

// ============================================================
// Core Vault Events (Match Mars Contract events.rs)
// ============================================================

// User deposits tokens into vault
message VaultDepositEvent {
  string user = 1;                  // Pubkey as base58 string
  bytes vault_id = 2;               // [u8; 32]
  uint64 amount = 3;                // Tokens deposited
  uint64 shares_received = 4;       // Shares minted
  uint32 protocol_id = 5;           // 1=Kamino, 2=Jupiter, 3=Mars
  int64 timestamp = 6;
}

// User withdraws tokens from vault
message VaultWithdrawEvent {
  string user = 1;
  bytes vault_id = 2;
  uint64 shares_burned = 3;         // Shares burned
  uint64 amount_received = 4;       // Tokens received
  uint32 protocol_id = 5;
  int64 timestamp = 6;
}

// Vault state update
message VaultStateUpdatedEvent {
  bytes vault_id = 1;
  uint64 total_deposits = 2;
  uint64 total_shares = 3;
  uint64 apy = 4;                   // APY in basis points
  uint32 active_protocols = 5;
  uint32 total_users = 6;
  int64 timestamp = 7;
}

// Protocol configuration update
message ProtocolConfigUpdatedEvent {
  bytes vault_id = 1;
  uint32 protocol_id = 2;
  bool enabled = 3;
  uint32 allocation_weight_bps = 4;
  uint32 target_allocation_bps = 5;
  uint64 current_allocation = 6;
  int64 timestamp = 7;
}

message FeeConfigUpdatedEvent {
  bytes vault_id = 1;
  uint32 deposit_fee_bps = 2;
  uint32 withdraw_fee_bps = 3;
  uint32 management_fee_bps = 4;
  uint32 performance_fee_bps = 5;
  string fee_recipient = 6;
  int64 timestamp = 7;
}

// Platform fee configuration update
message PlatformFeeUpdatedEvent {
  bytes vault_id = 1;
  uint32 old_platform_fee_bps = 2;
  uint32 new_platform_fee_bps = 3;
  string updated_by = 4;            // Admin who updated
  int64 timestamp = 5;
}

// Platform fee wallet update
message PlatformFeeWalletUpdatedEvent {
  string old_wallet = 1;
  string new_wallet = 2;
  string updated_by = 3;            // Admin who updated
  int64 timestamp = 4;
}

message EmergencyEvent {
  bytes vault_id = 1;
  EmergencyEventType event_type = 2;
  string reason = 3;
  string executor = 4;
  int64 timestamp = 5;
}

enum EmergencyEventType {
  EMERGENCY_EVENT_TYPE_UNSPECIFIED = 0;
  EMERGENCY_EVENT_TYPE_PAUSE = 1;
  EMERGENCY_EVENT_TYPE_RESUME = 2;
  EMERGENCY_EVENT_TYPE_EMERGENCY_WITHDRAW = 3;
  EMERGENCY_EVENT_TYPE_FORCE_REBALANCE = 4;
}

// Vault state snapshots for analytics
message VaultSnapshot {
  bytes vault_id = 1;
  string admin = 2;
  string base_token_mint = 3;
  string shares_mint = 4;
  uint64 total_deposits = 5;
  uint64 total_shares = 6;
  uint64 apy = 7;
  VaultStatus status = 8;
  repeated ProtocolAllocation protocols = 9;
  repeated UserPosition users = 10;
  FeeConfig fee_config = 11;
  uint32 platform_fee_bps = 12;          // Platform fee rate for farm rewards
  uint64 total_rewards_claimed = 13;     // Lifetime total rewards claimed
  uint64 total_platform_fee_collected = 14; // Lifetime platform fees collected
  int64 created_at = 15;
  int64 last_updated = 16;
}

message ProtocolAllocation {
  uint32 protocol_id = 1;
  string program_id = 2;
  bool enabled = 3;
  uint32 allocation_weight_bps = 4;
  uint64 current_allocation = 5;
  uint32 target_allocation_bps = 6;
}

message UserPosition {
  string user = 1;
  uint64 amount = 2;
  uint64 shares = 3;
  int64 timestamp = 4;
  uint64 total_rewards = 5;
}

message FeeConfig {
  uint32 deposit_fee_bps = 1;
  uint32 withdraw_fee_bps = 2;
  uint32 management_fee_bps = 3;
  uint32 performance_fee_bps = 4;
  string fee_recipient = 5;
  uint32 platform_fee_bps = 6;          // Platform fee for farm rewards (0-10000 bps)
}

enum VaultStatus {
  VAULT_STATUS_UNSPECIFIED = 0;
  VAULT_STATUS_ACTIVE = 1;
  VAULT_STATUS_PAUSED = 2;
  VAULT_STATUS_CLOSED = 3;
  VAULT_STATUS_EMERGENCY = 4;
}

// ============================================================
// Kamino Integration Events
// ============================================================

// Kamino vault deposit via CPI
message KaminoDepositEvent {
  string user = 1;
  bytes vault_id = 2;
  uint64 amount = 3;
  uint64 shares_received = 4;
  string kamino_vault = 5;          // Kamino vault pubkey
  int64 timestamp = 6;
}

// Kamino vault withdraw via CPI
message KaminoWithdrawEvent {
  string user = 1;
  bytes vault_id = 2;
  uint64 shares_burned = 3;
  uint64 amount_received = 4;
  string kamino_vault = 5;
  int64 timestamp = 6;
}

// Kamino farm stake event
message KaminoStakeEvent {
  string user = 1;
  bytes vault_id = 2;
  uint64 shares_amount = 3;
  string farm_address = 4;          // Kamino farm pubkey
  int64 timestamp = 5;
}

// Kamino farm unstake event (start + complete)
message KaminoUnstakeEvent {
  string user = 1;
  bytes vault_id = 2;
  uint64 shares_amount = 3;
  string farm_address = 4;
  bool is_start = 5;                // true=start_unstake, false=complete_unstake
  uint64 slot = 6;                  // Slot when unstake started
  int64 timestamp = 7;
}

// Kamino farm rewards claim event
message FarmRewardsClaimedEvent {
  string user = 1;                  // User who claimed rewards
  string vault_mint = 2;            // Vault base token mint (e.g., PYUSD)
  string farm_state = 3;            // Kamino farm state address
  string reward_mint = 4;           // Reward token mint (can be Token-2022)
  uint64 reward_amount = 5;         // Amount user received (after platform fee deduction)
  uint64 platform_fee = 6;          // Platform fee collected (in reward tokens)
  uint64 total_rewards_claimed = 7; // Lifetime total rewards claimed by vault
  int64 timestamp = 8;
}

// Analytics aggregations
message VaultAnalytics {
  bytes vault_id = 1;
  uint64 total_volume_24h = 2;
  uint64 total_volume_7d = 3;
  uint64 total_volume_30d = 4;
  uint64 total_fees_collected = 5;
  uint32 unique_users_24h = 6;
  uint32 unique_users_7d = 7;
  uint32 unique_users_total = 8;
  repeated ProtocolPerformance protocol_performance = 9;
  int64 timestamp = 10;
}

message ProtocolPerformance {
  uint32 protocol_id = 1;
  uint64 total_deposits = 2;
  uint64 total_withdrawals = 3;
  uint64 current_apy = 4;
  uint64 average_apy_7d = 5;
  uint64 total_rewards_generated = 6;
}